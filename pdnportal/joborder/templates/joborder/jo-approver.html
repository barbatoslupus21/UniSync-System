{% extends 'main.html' %}
{% load static %}

{% block title %}UniSync - Job Order{% endblock %}

{% block extra_css %}

<link rel="stylesheet" href="{% static 'css/jo-approver.css' %}">
{% endblock %}

{% block content %}
<main class="main-content">
    <!-- Header with page title and action button -->
    {% if request.user.job_order_approver %}
    <div class="JO-header">
        <div class="JO-title-section">
            <h1 class="JO-page-title">Approver Dashboard</h1>
            <p class="JO-subtitle">Review and process job order requests awaiting your approval</p>
        </div>
    </div>
    {% else %}
    <div class="JO-header">
        <div class="JO-title-section">
            <h1 class="JO-page-title">QA Verification Dashboard</h1>
            <p class="JO-subtitle">Review and verify completed job orders for quality assurance</p>
        </div>
    </div>
    {% endif %}

    <!-- Stats cards -->
    <div class="JO-stats-container">
        <div class="JO-stats-card JO-total AD-stats-card">
            <div class="JO-stats-icon">
                <i class="fas fa-inbox"></i>
            </div>
            <div class="JO-stats-content">
                <h3>Total Approval Request</h3>
                <h2 class="JO-stats-number">{{ joRequestsCount }}</h2>
                <p><span class="AD-stat-trend up"></span> this month</p>
            </div>
        </div>
        
        <div class="JO-stats-card JO-approved AD-stats-card">
            <div class="JO-stats-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="JO-stats-content">
                <h3>Approved by You</h3>
                <h2 class="JO-stats-number">{{ approvedJOCount }}</h2>
                <p><span class="AD-stat-trend up"></span> this month</p>
            </div>
        </div>
        
        <div class="JO-stats-card JO-pending AD-stats-card">
            <div class="JO-stats-icon">
                <i class="fas fa-times-circle"></i>
            </div>
            <div class="JO-stats-content">
                <h3>Rejected by You</h3>
                <h2 class="JO-stats-number">{{ rejectedJOCount }}</h2>
                <p><span class="AD-stat-trend down"></span> this month</p>
            </div>
        </div>
        
        <div class="JO-stats-card JO-approval AD-stats-card">
            <div class="JO-stats-icon">
                <i class="fas fa-hourglass-half"></i>
            </div>
            <div class="JO-stats-content">
                <h3>Awaiting Your Approval</h3>
                <h2 class="JO-stats-number">{{ pendingJOCount }}</h2>
                <p><span class="AD-stat-trend up positive"></span> this month</p>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="JO-main-content-grid">
        <!-- Approval Stage Overview -->
        <div class="JO-card AD-approval-stages JO-chart-container">
            <div class="JO-card-header">
                <h2>Approval Process Overview</h2>
                <div class="JO-card-actions">
                    <select id="chart-period-selector" class="JO-select">
                        <option value="3month">Last 3 Months</option>
                        <option value="6month" selected>Last 6 Months</option>
                        <option value="1year">Last Year</option>
                    </select>
                </div>
            </div>
            <div class="JO-chart-wrapper">
                <canvas id="approval-stage-chart"></canvas>
            </div>
        </div>

        <!-- Action Required section -->
        <div class="JO-card AD-action-required JO-chart-container">
            <div class="JO-card-header">
                <h2>Action Required <span class="AD-tag">Priority</span></h2>
            </div>
            
            <div class="AD-priority-list" id="priority-list">
                {% if pending_approvals %}
                    {% for approval in pending_approvals %}
                        {% if approval.request_at <= three_days_ago %}
                        <div class="AD-priority-item AD-overdue" data-jo-id="{{ approval.jo_number.jo_number }}">
                            <div class="AD-priority-header">
                                <div class="AD-priority-left">
                                    <span class="AD-priority-badge">Overdue</span>
                                    <span class="JO-pending-id">{{ approval.jo_number.jo_number }}</span>
                                    <span class="JO-category JO-category-{{ approval.jo_number.jo_color|lower }}">{{ approval.jo_number.jo_color }}</span>
                                </div>
                            </div>
                            <div class="AD-priority-details">
                                <div class="AD-details-col">
                                    <p><strong>Requester:</strong> {{ approval.jo_request.name }} ({{ approval.jo_request.line.line_name }})</p>
                                    <p><strong>Tool:</strong> {{ approval.jo_number.jo_tools }}</p>
                                    <p><strong>Nature:</strong> {{ approval.jo_number.jo_type }}</p>
                                </div>
                                <div class="AD-approval-actions">
                                    <button class="JO-button JO-view-details-btn" data-id="{{ approval.jo_number.id }}" data-number="{{ approval.jo_number.jo_number }}">
                                        View Details
                                    </button>
                                    <button class="JO-button JO-success-button AD-approve-btn" data-id="{{ approval.jo_number.id }}" data-number="{{ approval.jo_number.jo_number }}">
                                        <i class="fas fa-check"></i> Approve
                                    </button>
                                    <button class="JO-button JO-danger-button AD-reject-btn" data-id="{{ approval.jo_number.id }}" data-number="{{ approval.jo_number.jo_number }}">
                                        <i class="fas fa-times"></i> Reject
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="AD-priority-item" data-jo-id="{{ approval.jo_number.jo_number }}">
                            <div class="AD-priority-header">
                                <div class="AD-priority-left">
                                    <span class="JO-pending-id">{{ approval.jo_number.jo_number }}</span>
                                    <span class="JO-category JO-category-{{ approval.jo_number.jo_color|lower }}">{{ approval.jo_number.jo_color }}</span>
                                </div>
                            </div>
                            <div class="AD-priority-details">
                                <div class="AD-details-col">
                                    <p><strong>Requester:</strong> {{ approval.jo_request.name }} ({{ approval.jo_request.line.line_name }})</p>
                                    <p><strong>Tool:</strong> {{ approval.jo_number.jo_tools }}</p>
                                    <p><strong>Nature:</strong> {{ approval.jo_number.jo_type }}</p>
                                </div>
                                <div class="AD-approval-actions">
                                    <button class="JO-button JO-view-details-btn" data-id="{{ approval.jo_number.id }}" data-number="{{ approval.jo_number.jo_number }}">
                                        View Details
                                    </button>
                                    <button class="JO-button JO-success-button AD-approve-btn" data-id="{{ approval.jo_number.id }}" data-number="{{ approval.jo_number.jo_number }}">
                                        <i class="fas fa-check"></i> Approve
                                    </button>
                                    <button class="JO-button JO-danger-button AD-reject-btn" data-id="{{ approval.jo_number.id }}" data-number="{{ approval.jo_number.jo_number }}">
                                        <i class="fas fa-times"></i> Reject
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <div class="AD-no-requests">
                        <div class="AD-empty-state">
                            <i class="fas fa-check-circle"></i>
                            <h3>All caught up!</h3>
                            <p>There are no pending requests that require your approval at this time.</p>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Request History Table -->
    <div class="JO-card AD-all-requests">
        <div class="JO-card-header">
            <h2>Request History</h2>
            <div class="JO-card-actions">
                <div class="JO-search-container">
                    <input type="text" class="JO-search-input" placeholder="Search by JO Number, requester, type...">
                    <button class="JO-search-button">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div class="JO-filter-container">
                    <select class="JO-select JO-filter-select">
                        <option value="all" selected>All Categories</option>
                        <option value="green">Green</option>
                        <option value="yellow">Yellow</option>
                        <option value="white">White</option>
                        <option value="orange">Orange</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="JO-table-container">
            <table class="JO-table AD-requests-table">
                <thead>
                    <tr>
                        <th>JO Number</th>
                        <th>Category</th>
                        <th>Tools</th>
                        <th>Nature of Changes</th>
                        <th>Status</th>
                        <th>Requested By</th>
                        <th>Requested At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for approval in approval_history %}
                        <tr {% if approval.is_overdue %}class="AD-overdue-row"{% elif approval.is_today %}class="AD-due-today-row"{% endif %}>
                            <td data-label="JO Number">{{ approval.jo_number.jo_number }}</td>
                            <td data-label="Category"><span class="JO-category-pill JO-category-{{ approval.jo_number.jo_color|lower }}">{{ approval.jo_number.jo_color }}</span></td>
                            <td data-label="Tools">{{ approval.jo_number.jo_tools }}</td>
                            <td data-label="Type">{{ approval.jo_number.jo_type }}</td>
                            <td data-label="Status"><span class="JO-status JO-status-{{ approval.jo_number.status|lower }}">{{ approval.jo_number.status }}</span></td>
                            <td data-label="Preparer">{{ approval.jo_number.prepared_by.name}}</td>
                            <td data-label="Requested at">
                                <span class="AD-due-date {% if request_at <= three_days_ago%}overdue{% endif %}">
                                    {{ approval.request_at|date:"M d, Y" }}
                                </span>
                            </td>
                            <td data-label="Actions">
                                <div class="AD-table-actions">
                                    <button class="JO-icon-button" title="View Details" data-id="{{ approval.jo_number.id }}" data-number="{{ approval.jo_number.jo_number }}">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="7" class="JO-empty-table">No approval history found.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</main>

<!-- Job Order Details Modal with Approval Timeline -->
<div class="JO-modal" id="jo-details-modal">
    <div class="JO-modal-content">
        <div class="JO-modal-header">
            <h2>Job Order Details</h2>
            <button class="JO-modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="JO-modal-body" id="jo-details-content">
            <!-- Loading state is shown initially -->
            <div class="JO-loading text-center p-5">
                <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                <p>Loading job order details...</p>
            </div>
        </div>
        <div class="JO-modal-footer">
            <button class="JO-button JO-secondary-button close-details-modal">Close</button>
            <!-- Dynamic buttons will be added here based on permissions -->
        </div>
    </div>
</div>

<!-- Approval Confirmation Modal -->
<div class="JO-modal JO-confirmation-modal" id="approve-confirm-modal">
    <div class="JO-modal-content">
        <div class="JO-modal-header">
            <h2>Confirm Approval</h2>
            <button class="JO-modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="JO-modal-body">
            <div style="text-align: center;">
                <i class="fas fa-check-circle JO-confirmation-icon success"></i>
                <p class="JO-confirmation-message">Are you sure you want to approve job order <strong id="approve-jo-number"></strong>?</p>
                <p class="JO-confirmation-submessage">This will move the request to the next stage in the approval process.</p>
                
                <form id="approve-form" method="POST" action="{% if request.user.job_order_approver %}{% url "approve_job_order" %}{% else %}{% url "approve_checking" %}{% endif %}">
                    {% csrf_token %}
                    <input type="hidden" name="jo_id" id="approve-jo-id">
                    <div class="JO-form-group modal-input">
                        <label for="approval-remarks" style="text-align: start;">Remarks (Optional)</label>
                        <textarea id="approval-remarks" name="remarks" rows="3" placeholder="Add any comments or instructions for the next approver..."></textarea>
                    </div>
                </form>
            </div>
        </div>
        <div class="JO-modal-footer">
            <button class="JO-button JO-secondary-button" id="cancel-approval">Cancel</button>
            <button class="JO-button JO-success-button" id="confirm-approve-btn">Confirm Approval</button>
        </div>
    </div>
</div>

<!-- Rejection Confirmation Modal -->
<div class="JO-modal JO-confirmation-modal" id="reject-confirm-modal">
    <div class="JO-modal-content">
        <div class="JO-modal-header">
            <h2>Confirm Rejection</h2>
            <button class="JO-modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="JO-modal-body">
            <div style="text-align: center;">
                <i class="fas fa-exclamation-triangle JO-confirmation-icon danger"></i>
                <p class="JO-confirmation-message">Are you sure you want to reject job order <strong id="reject-jo-number"></strong>?</p>
                <p class="JO-confirmation-submessage">This will return the request to the requestor with your feedback.</p>
                
                <form id="reject-form" method="POST" action="{% if request.user.job_order_approver %}{% url "reject_job_order" %}{% else %}{% url "reject_checking" %}{% endif %}">
                    {% csrf_token %}
                    <input type="hidden" name="jo_id" id="reject-jo-id">
                    <div class="JO-form-group modal-input">
                        <label for="rejection-remarks" style="text-align: start;">Rejection Reason <span class="AD-required">*</span></label>
                        <textarea id="rejection-remarks" name="remarks" rows="3" placeholder="Please provide a detailed reason for rejection..." required></textarea>
                        <small class="AD-input-error" id="rejection-error" style="display: none;">Please provide a reason for rejection</small>
                    </div>
                </form>
            </div>
        </div>
        <div class="JO-modal-footer">
            <button class="JO-button JO-secondary-button" id="cancel-rejection">Cancel</button>
            <button class="JO-button JO-danger-button" id="confirm-reject-btn">Confirm Rejection</button>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toast-container"></div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="{% static 'js/jo-approver.js' %}"></script>
{% endblock %}